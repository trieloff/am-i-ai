name: Propagate Updates to Dependent Repos
# Propagates am-i-ai updates to ai-aligned-git and ai-aligned-gh

on:
  push:
    branches:
      - main
    paths:
      - 'am-i-ai.sh'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target repo (all, ai-aligned-git, ai-aligned-gh)'
        required: false
        default: 'all'

jobs:
  propagate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - name: ai-aligned-git
            file: executable_git
            marker: "# --- BEGIN BUNDLED am-i-ai ---"
            end_marker: "# --- END BUNDLED am-i-ai ---"
          - name: ai-aligned-gh
            file: executable_gh
            marker: "# --- BEGIN BUNDLED am-i-ai ---"
            end_marker: "# --- END BUNDLED am-i-ai ---"
      fail-fast: false

    steps:
      - name: Check if should run for this repo
        id: should-run
        run: |
          TARGET="${{ github.event.inputs.target || 'all' }}"
          if [ "$TARGET" = "all" ] || [ "$TARGET" = "${{ matrix.repo.name }}" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout am-i-ai
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          path: am-i-ai

      - name: Checkout target repo
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          repository: trieloff/${{ matrix.repo.name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: target-repo

      - name: Extract and bundle detection functions
        if: steps.should-run.outputs.run == 'true'
        id: bundle
        run: |
          cd am-i-ai

          # Get version
          VERSION=$(grep 'AMI_VERSION=' am-i-ai.sh | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract function definitions from am-i-ai.sh
          # This creates a bundled version that can be inserted into other scripts
          {
            echo '# --- BEGIN BUNDLED am-i-ai ---'
            echo "# Bundled from am-i-ai v$VERSION"
            echo '# https://github.com/trieloff/am-i-ai'
            echo '#'
            echo '# This code is auto-generated. Do not edit manually.'
            echo '# To update, run the propagate-updates workflow in am-i-ai.'
            echo ''
          } > ../bundled-functions.sh

          # Extract the core functions (skip shebang, CLI handling, version checks)
          awk '
            /^ami_process_contains\(\)/,/^}$/ { print; next }
            /^ami_check_env\(\)/,/^}$/ { print; next }
            /^ami_check_ps_tree\(\)/,/^}$/ { print; next }
            /^ami_detect\(\)/,/^}$/ { print; next }
            /^ami_is_ai\(\)/,/^}$/ { print; next }
            /^ami_detect_all\(\)/,/^}$/ { print; next }
            /^ami_get_email\(\)/,/^}$/ { print; next }
            /^ami_get_name\(\)/,/^}$/ { print; next }
            /^_ami_debug\(\)/,/^}$/ { print; next }
          ' am-i-ai.sh >> ../bundled-functions.sh

          # Add function aliases
          {
            echo ''
            echo '# Function aliases for backward compatibility'
            echo 'process_contains() { ami_process_contains "$@"; }'
            echo 'check_env_vars() { ami_check_env; }'
            echo 'check_ps_tree() { ami_check_ps_tree; }'
            echo 'detect_ai_tool() { ami_detect; }'
            echo '# --- END BUNDLED am-i-ai ---'
          } >> ../bundled-functions.sh

          echo "Generated bundled functions:"
          head -20 ../bundled-functions.sh

      - name: Update target script
        if: steps.should-run.outputs.run == 'true'
        id: update
        run: |
          cd target-repo
          TARGET_FILE="${{ matrix.repo.file }}"
          VERSION="${{ steps.bundle.outputs.version }}"

          if [ ! -f "$TARGET_FILE" ]; then
            echo "Target file not found: $TARGET_FILE"
            echo "changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if target has bundle markers
          if grep -q "# --- BEGIN BUNDLED am-i-ai ---" "$TARGET_FILE"; then
            echo "Found existing bundle markers, replacing..."

            # Create new file with replaced bundle section
            awk '
              /^# --- BEGIN BUNDLED am-i-ai ---$/ {
                skip = 1
                system("cat ../bundled-functions.sh")
                next
              }
              /^# --- END BUNDLED am-i-ai ---$/ {
                skip = 0
                next
              }
              !skip { print }
            ' "$TARGET_FILE" > "${TARGET_FILE}.new"

            mv "${TARGET_FILE}.new" "$TARGET_FILE"
            chmod +x "$TARGET_FILE"
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "No bundle markers found in $TARGET_FILE"
            echo "Please add markers to enable auto-updates:"
            echo "  # --- BEGIN BUNDLED am-i-ai ---"
            echo "  # --- END BUNDLED am-i-ai ---"
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR if changes
        if: steps.should-run.outputs.run == 'true' && steps.update.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          cd target-repo
          VERSION="${{ steps.bundle.outputs.version }}"
          BRANCH="update-am-i-ai-v$VERSION-$(date +%Y%m%d%H%M%S)"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update bundled am-i-ai to v$VERSION"

          git push origin "$BRANCH"

          # Create PR body in a file to avoid YAML multiline issues
          cat > /tmp/pr-body.md << EOF
          ## Summary

          Automatically updates the bundled am-i-ai detection functions to v$VERSION.

          ## What changed

          See the am-i-ai changelog: https://github.com/trieloff/am-i-ai/commits/main

          ## Test plan

          - [ ] Run detection tests
          - [ ] Verify AI tool detection still works

          ---

          Generated by [am-i-ai propagate workflow](https://github.com/trieloff/am-i-ai/actions)
          EOF

          gh pr create \
            --title "Update bundled am-i-ai to v$VERSION" \
            --body-file /tmp/pr-body.md \
            --base main \
            --head "$BRANCH"
