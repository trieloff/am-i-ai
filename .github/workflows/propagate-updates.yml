name: Propagate Updates to Dependent Repos

on:
  push:
    branches:
      - main
    paths:
      - 'am-i-ai.sh'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target repo (all, ai-aligned-git, ai-aligned-gh)'
        required: false
        default: 'all'

jobs:
  propagate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - name: ai-aligned-git
            file: executable_git
          - name: ai-aligned-gh
            file: executable_gh
      fail-fast: false

    steps:
      - name: Check if should run for this repo
        id: should-run
        run: |
          TARGET="${{ github.event.inputs.target || 'all' }}"
          if [ "$TARGET" = "all" ] || [ "$TARGET" = "${{ matrix.repo.name }}" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout am-i-ai
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          path: am-i-ai

      - name: Checkout target repo
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          repository: trieloff/${{ matrix.repo.name }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: target-repo

      - name: Extract detection functions from am-i-ai
        if: steps.should-run.outputs.run == 'true'
        id: extract
        run: |
          # Extract the core detection functions from am-i-ai.sh
          # These are the functions that need to be embedded in the target scripts

          cd am-i-ai

          # Get version
          VERSION=$(grep 'AMI_VERSION=' am-i-ai.sh | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract functions between markers (we'll create a snippet file)
          cat > detection-functions.sh << 'DETECTION_EOF'
# AI Detection Functions
# Extracted from am-i-ai v${VERSION}
# https://github.com/trieloff/am-i-ai

# Function to check if a process name contains a pattern (case-insensitive)
process_contains() {
    local pid=$1
    local pattern=$2

    # Get process command and name
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        ps -p "$pid" -o comm= 2>/dev/null | grep -qi "$pattern" || \
        ps -p "$pid" -o command= 2>/dev/null | grep -qi "$pattern"
    else
        # Linux
        ps -p "$pid" -o comm= 2>/dev/null | grep -qi "$pattern" || \
        ps -p "$pid" -o cmd= 2>/dev/null | grep -qi "$pattern"
    fi
}

DETECTION_EOF

          # Extract check_env_vars function
          sed -n '/^ami_check_env()/,/^}/p' am-i-ai.sh | \
            sed 's/ami_check_env/check_env_vars/g' | \
            sed 's/_ami_debug/debug_log/g' >> detection-functions.sh

          # Extract check_ps_tree function
          sed -n '/^ami_check_ps_tree()/,/^}/p' am-i-ai.sh | \
            sed 's/ami_check_ps_tree/check_ps_tree/g' | \
            sed 's/ami_process_contains/process_contains/g' | \
            sed 's/_ami_debug/debug_log/g' >> detection-functions.sh

          # Extract detect_ai_tool function
          sed -n '/^ami_detect()/,/^}/p' am-i-ai.sh | \
            sed 's/ami_detect/detect_ai_tool/g' | \
            sed 's/ami_check_env/check_env_vars/g' | \
            sed 's/ami_check_ps_tree/check_ps_tree/g' | \
            sed 's/_ami_debug/debug_log/g' >> detection-functions.sh

          echo "Extracted detection functions:"
          cat detection-functions.sh

      - name: Check for changes needed
        if: steps.should-run.outputs.run == 'true'
        id: check-changes
        run: |
          cd target-repo

          # Check if the target file exists
          if [ ! -f "${{ matrix.repo.file }}" ]; then
            echo "Target file ${{ matrix.repo.file }} not found"
            echo "changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For now, we'll create the PR regardless and let humans review
          # In future, we could do a smarter diff of the detection functions
          echo "changes=true" >> $GITHUB_OUTPUT

      - name: Create branch and PR
        if: steps.should-run.outputs.run == 'true' && steps.check-changes.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          cd target-repo

          VERSION="${{ steps.extract.outputs.version }}"
          BRANCH="update-am-i-ai-$VERSION-$(date +%Y%m%d%H%M%S)"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create new branch
          git checkout -b "$BRANCH"

          # Copy the am-i-ai.sh library for reference
          cp ../am-i-ai/am-i-ai.sh vendor-am-i-ai.sh 2>/dev/null || true

          # Stage changes
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit
          git commit -m "Update AI detection from am-i-ai v$VERSION

This PR updates the AI detection functions to match am-i-ai v$VERSION.

Changes were automatically propagated from:
https://github.com/trieloff/am-i-ai

Please review the detection logic changes and update the local
functions accordingly.

Generated by: https://github.com/trieloff/am-i-ai/actions"

          # Push
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "Update AI detection from am-i-ai v$VERSION" \
            --body "## Summary

This PR updates the AI detection functions to match am-i-ai v$VERSION.

## Changes

The am-i-ai library has been updated with new detection logic. Please review the changes and update the local detection functions in \`${{ matrix.repo.file }}\` accordingly.

### Reference

- Source: https://github.com/trieloff/am-i-ai
- Version: v$VERSION

## Manual Steps Required

1. Review the detection changes in \`vendor-am-i-ai.sh\`
2. Update the local \`process_contains\`, \`check_env_vars\`, \`check_ps_tree\`, and \`detect_ai_tool\` functions
3. Test the changes locally
4. Merge this PR

---

Generated by [am-i-ai propagate workflow](https://github.com/trieloff/am-i-ai/actions)" \
            --base main \
            --head "$BRANCH"
